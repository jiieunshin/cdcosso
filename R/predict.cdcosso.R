#' Load a matrix from a file
#'
#' The predict.cdcosso function is a function that receives the object and test data (testx) of the cdcosso package as input
#' and generates a predicted value for the test data.
#' This function uses the given test data to calculate predictions from the weights and biases generated by the model.
#'
#' @param object Model object fitted from the cdcosso package.
#' @param testx The test data you want to predict.
#'
#' @return a list containing the predicted value for the test data (f.new) and the transformed value of that predicted value (mu.new).
#' @export

predict.cdcosso = function(object, testx)
{
  testx = apply(testx, 2, rescale)
  K = make_anovaKernel(testx, object$data$x, object$data$kernel, object$data$kparam)

  tr_n = dim(object$data$x)[1]
  te_n <- dim(testx)[1]

  d = K$numK
  R = array(NA, c(te_n, tr_n, d))

  for(j in 1:d){
    R[, , j] = K$K[[j]]
  }

  wt = rep(1, d)

  Rtheta <- wsGram(R, object$theta_step$theta.new/wt^2)

  # if(object$algorithm == "QP"){
  #   sdx <- sqrt(drop(rep(1, te_n) %*% (Rtheta^2))/(tr_n - 1))
  #   c.new = object$c_step$c.new / sdx
  # } else if(object$algorithm == "CD"){
  # }

  c.new = object$c_step$c.new
  f.new = c(Rtheta %*% c.new + object$c_step$b.new)
  mu.new = object$object$linkinv(f.new)

  return(list(f.new = f.new, mu.new = mu.new))
}


